<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> CAET Flash Cards ‚Äì Standalone </title>
  <style>
    :root{
      --bg: #f8fafc; /* slate-50 */
      --card: #ffffff;
      --text: #0f172a; /* slate-900 */
      --muted: #64748b; /* slate-500 */
      --border: #e2e8f0; /* slate-200 */
      --ring: #cbd5e1; /* slate-300 */
      --green: #16a34a; /* green-600 */
      --green-50: #ecfdf5;
      --yellow: #f59e0b; /* yellow-500 */
      --yellow-50: #fffbeb;
      --red: #dc2626; /* red-600 */
      --red-50: #fef2f2;
      --shadow: 0 10px 20px rgba(2, 6, 23, 0.06), 0 2px 6px rgba(2, 6, 23, 0.06);
    }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(to bottom,var(--bg),#fff);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:28px;letter-spacing:-0.01em;display:flex;align-items:center;gap:10px}
    .sparkle{width:24px;height:24px}
    .deck-switch{display:inline-flex;border:1px solid var(--border);border-radius:999px;padding:6px;background:#fff;box-shadow:var(--shadow)}
    .chip{border:1px solid transparent;background:transparent;color:var(--text);padding:6px 12px;border-radius:999px;cursor:pointer}
    .chip.active{background:#111827;color:#fff}

    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow)}
    .card h2{margin:0;padding:16px 20px;border-bottom:1px solid var(--border);font-size:18px}
    .card .content{padding:18px 20px}

    .flip{position:relative;height:300px;border-radius:16px;border:1px solid var(--border);background:#fff;cursor:pointer;user-select:none;perspective:1000px}
    .flip-inner{position:relative;height:100%;transform-style:preserve-3d;transition:transform .4s}
    .flip .face{position:absolute;inset:0;display:grid;place-items:center;backface-visibility:hidden;-webkit-backface-visibility:hidden;padding:16px;text-align:center}
    .flip .back{transform:rotateY(180deg)}
    .flip.is-flipped .flip-inner{transform:rotateY(180deg)}

    .meta{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.08em}
    .term{font-size:28px;font-weight:700;margin-top:6px}
    .unit{font-size:14px;color:var(--muted);margin-top:4px}
    .badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;margin:4px 4px 0 0}

    .def{max-width:70ch;font-size:18px;line-height:1.4;max-height:180px;overflow:auto;padding-right:8px}

    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:16px}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 14px;font-size:14px;cursor:pointer}
    .btn:focus{outline:2px solid var(--ring);outline-offset:2px}
    .btn-outline{background:#fff}
    .btn-primary{background:#111827;color:#fff;border-color:#111827}
    .btn-ghost{background:transparent}

    .btn-green{color:var(--green);border-color:#bbf7d0;background:var(--green-50)}
    .btn-green.active{background:var(--green);color:#fff;border-color:var(--green)}
    .btn-yellow{color:var(--yellow);border-color:#fef3c7;background:var(--yellow-50)}
    .btn-yellow.active{background:var(--yellow);color:#fff;border-color:var(--yellow)}
    .btn-red{color:var(--red);border-color:#fecaca;background:var(--red-50)}
    .btn-red.active{background:var(--red);color:#fff;border-color:var(--red)}

    .list{max-height:330px;overflow:auto;padding-right:6px}
    .list-item{border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:10px}
    .list-item .title{font-weight:600}
    .list-item .line{color:var(--muted);font-size:12px;margin-top:6px}

    .bottom{margin-top:20px}
    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#fff;cursor:pointer}
    .tag.active{background:#111827;color:#fff;border-color:#111827}

    .search{display:flex;align-items:center;gap:10px;margin-top:12px}
    .search input{flex:1;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px}

    .empty{padding:28px;text-align:center;color:var(--muted)}

    @media (max-width:720px){
      header{flex-direction:column;align-items:flex-start;gap:12px}
      .row{flex-direction:column;align-items:stretch}
      .def{max-height:150px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>
        <svg class="sparkle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M12 2l1.9 4.6L18 8l-4.1 1.4L12 14l-1.9-4.6L6 8l4.1-1.4L12 2z"/>
        </svg>
        AEA Interactive Glossary
      </h1>
      <div class="deck-switch" id="deckSwitch">
        <button class="chip active" data-deck="all">All</button>
        <button class="chip" data-deck="easy">Easy <span class="count" data-count="easy"></span></button>
        <button class="chip" data-deck="medium">Medium <span class="count" data-count="medium"></span></button>
        <button class="chip" data-deck="difficult">Difficult <span class="count" data-count="difficult"></span></button>
      </div>
      <button class="btn btn-primary" id="finishSession" style="margin-top:8px;width:100%;max-width:200px;">Finish Session</button>
    </header>

    <section class="card">
      <h2>Study <span class="meta" style="margin-left:8px">[Space: Flip ‚Ä¢ ‚Üê/‚Üí: Prev/Next]</span></h2>
      <div class="content">
        <div class="flip" id="flip">
          <div class="flip-inner" id="flipInner">
            <div class="face front" id="front"></div>
            <div class="face back" id="back"></div>
          </div>
        </div>
        <div class="row">
          <div class="row" id="ratingRow">
            <button class="btn btn-green" id="rateEasy">Easy</button>
            <button class="btn btn-yellow" id="rateMedium">Medium</button>
            <button class="btn btn-red" id="rateDifficult">Difficult</button>
          </div>
          <div class="row">
            <button class="btn btn-outline" id="prev">Prev</button>
            <button class="btn btn-primary" id="next">Next ‚ñ∂</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h2>List View</h2>
      <div class="content">
        <div class="list" id="list"></div>
      </div>
    </section>

    <section class="card bottom" style="margin-bottom:8px">
      <h2>Filter</h2>
      <div class="content">
        <div class="tags" id="tags"></div>
        <div class="search">
          <input id="search" type="search" placeholder="Search term, definition, unit, or tag" />
        </div>
      </div>
    </section>
  </div>

<script>
(function(){
  // ---------- Data (embedded directly ‚Äì no document.write) ----------
  const FIXED_CARDS = [

  {
    "term": "Alternating Current (AC)",
    "definition": "Electrical current that periodically reverses direction, typically following a sinusoidal waveform. In aircraft, AC systems operate at 400Hz and provide 115V/200V for efficient power distribution.",
    "analogy": "Water sloshing back and forth in a pipe, versus DC which flows in one direction like a river.",
    "unit": "AC Fundamentals",
    "tags": "AC 101|fundamentals|waveforms"
  },
  {
    "term": "Frequency (f)",
    "definition": "The number of complete AC cycles per second, measured in Hertz (Hz). Aircraft use 400Hz AC because higher frequency allows smaller, lighter transformers and motors compared to 60Hz residential power.",
    "analogy": "How many times per second the current completes a full back-and-forth cycle.",
    "unit": "Hertz (Hz)",
    "tags": "AC 101|waveforms|measurement"
  },
  {
    "term": "Period (T)",
    "definition": "The time required for one complete AC cycle, calculated as T = 1/f. For 400Hz aircraft systems, the period is 2.5 milliseconds.",
    "analogy": "The duration of one complete swing of a pendulum back and forth.",
    "unit": "Seconds (s)",
    "tags": "AC 101|waveforms|calculation"
  },
  {
    "term": "Peak Voltage (V_peak)",
    "definition": "The maximum instantaneous voltage reached during an AC cycle, occurring at 90¬∞ and 270¬∞ of the sine wave. Peak voltage is 1.414 times the RMS voltage.",
    "analogy": "The highest point of a wave crest or the deepest point of a wave trough.",
    "unit": "Volt (V)",
    "tags": "waveforms|measurement"
  },
  {
    "term": "RMS Voltage (V_RMS)",
    "definition": "Root Mean Square voltage - the effective DC equivalent value of AC voltage. RMS = Peak √ó 0.707. Aircraft 115V AC is an RMS value (peak is actually 162.6V).",
    "analogy": "The 'average working value' of AC that does the same work as an equivalent DC voltage.",
    "unit": "Volt (V)",
    "tags": "waveforms|measurement|calculation"
  },
  {
    "term": "Phase Angle",
    "definition": "The angular position in an AC cycle, measured in degrees (0¬∞ to 360¬∞). Phase relationships between voltage and current are critical in AC circuit analysis.",
    "analogy": "The position of a clock hand - 90¬∞ is quarter past, 180¬∞ is half past, etc.",
    "unit": "Degrees (¬∞)",
    "tags": "waveforms|phase"
  },
  {
    "term": "Inductance (L)",
    "definition": "The property of a circuit that opposes changes in current by storing energy in a magnetic field, measured in Henrys (H). Found in motors, generators, transformers, and relays.",
    "analogy": "Electrical inertia - like the momentum of a heavy flywheel that resists speeding up or slowing down.",
    "unit": "Henry (H)",
    "tags": "inductance|fundamentals"
  },
  {
    "term": "Inductive Reactance (X_L)",
    "definition": "The opposition to AC current flow caused by inductance, calculated as X_L = 2œÄfL. Increases with frequency - inductors pass DC but oppose AC.",
    "analogy": "A frequency-dependent resistance that gets stronger as AC frequency increases.",
    "unit": "Ohm (Œ©)",
    "tags": "inductance|reactance|formula"
  },
  {
    "term": "ELI the ICE man",
    "definition": "Memory aid for phase relationships: In inductors (L), voltage (E) leads current (I). In capacitors (C), current (I) leads voltage (E).",
    "analogy": "ELI = voltage leads in inductors; ICE = current leads in capacitors.",
    "unit": "AC Phase (Tool)",
    "tags": "phase|formula|tool"
  },
  {
    "term": "Capacitance (C)",
    "definition": "The ability to store electrical energy in an electric field between two conductive plates, measured in Farads (F). Used for filtering, power factor correction, and energy storage.",
    "analogy": "An electrical storage tank that fills and empties with charge.",
    "unit": "Farad (F)",
    "tags": "capacitance|fundamentals"
  },
  {
    "term": "Capacitive Reactance (X_C)",
    "definition": "The opposition to AC current flow caused by capacitance, calculated as X_C = 1/(2œÄfC). Decreases with frequency - capacitors block DC but pass AC.",
    "analogy": "A frequency-dependent resistance that gets weaker as AC frequency increases.",
    "unit": "Ohm (Œ©)",
    "tags": "capacitance|reactance|formula"
  },
  {
    "term": "Impedance (Z)",
    "definition": "The total opposition to AC current flow, combining resistance and reactance: Z = ‚àö(R¬≤ + X¬≤). Impedance is the AC equivalent of resistance.",
    "analogy": "The total 'friction' in an AC circuit from all sources - resistance, inductance, and capacitance.",
    "unit": "Ohm (Œ©)",
    "tags": "impedance|formula|calculation"
  },
  {
    "term": "Resonance",
    "definition": "The condition where inductive reactance equals capacitive reactance (X_L = X_C), causing them to cancel. At resonance, impedance equals resistance only.",
    "analogy": "The frequency at which a circuit naturally 'vibrates' - like pushing a swing at just the right time.",
    "unit": "AC Circuits (Concept)",
    "tags": "resonance|circuits"
  },
  {
    "term": "Real Power (P)",
    "definition": "The actual power consumed and converted to useful work, measured in Watts (W). Calculated as P = VI √ó cos(Œ∏) or P = VI √ó PF.",
    "analogy": "The actual work being performed - the power that shows up on your electric bill.",
    "unit": "Watt (W)",
    "tags": "power|calculation"
  },
  {
    "term": "Reactive Power (Q)",
    "definition": "Power that oscillates between source and reactive components (inductors/capacitors) without doing useful work, measured in Volt-Amperes Reactive (VAR).",
    "analogy": "Energy that sloshes back and forth but doesn't actually accomplish work.",
    "unit": "VAR",
    "tags": "power|calculation"
  },
  {
    "term": "Apparent Power (S)",
    "definition": "The total power supplied by the source, combining real and reactive power: S = VI, measured in Volt-Amperes (VA). This is what generators must be sized for.",
    "analogy": "The total effort the source must provide, whether or not it all becomes useful work.",
    "unit": "Volt-Ampere (VA)",
    "tags": "power|calculation"
  },
  {
    "term": "Power Factor (PF)",
    "definition": "The ratio of real power to apparent power: PF = P/S = cos(Œ∏). Ranges from 0 to 1; unity (1.0) means all power is doing useful work.",
    "analogy": "The efficiency of power usage - like the percentage of your effort that actually accomplishes work.",
    "unit": "Ratio (0-1)",
    "tags": "power|power_factor"
  },
  {
    "term": "Lagging Power Factor",
    "definition": "When current lags behind voltage, caused by inductive loads like motors. This is the most common type in aircraft systems and requires power factor correction.",
    "analogy": "The current is 'late to the party' compared to voltage.",
    "unit": "Power Factor (Concept)",
    "tags": "power_factor|troubleshooting"
  },
  {
    "term": "Power Factor Correction",
    "definition": "Adding capacitors to an inductive circuit to provide leading reactive power that cancels lagging reactive power, improving the power factor toward unity.",
    "analogy": "Balancing the system so less total power is wasted on reactive components.",
    "unit": "AC Power (Concept)",
    "tags": "power_factor|maintenance"
  },
  {
    "term": "Transformer",
    "definition": "A device that transfers electrical energy between circuits through electromagnetic induction, allowing voltage to be increased (step-up) or decreased (step-down).",
    "analogy": "An electrical gear ratio - trading voltage for current or vice versa.",
    "unit": "AC Device",
    "tags": "transformers|devices"
  },
  {
    "term": "Turns Ratio",
    "definition": "The ratio of primary to secondary windings in a transformer, determining voltage transformation: V_secondary/V_primary = N_secondary/N_primary.",
    "analogy": "Like gear teeth - more turns on secondary = higher output voltage.",
    "unit": "Ratio",
    "tags": "transformers|formula"
  },
  {
    "term": "Three-Phase Power",
    "definition": "Three AC waveforms separated by 120¬∞, providing more efficient power delivery than single-phase. Standard in aircraft: 115/200V at 400Hz.",
    "analogy": "Three pistons firing in sequence for smooth, continuous power delivery.",
    "unit": "AC System",
    "tags": "three_phase|fundamentals"
  },
  {
    "term": "Wye (Y) Connection",
    "definition": "Three-phase configuration with a common neutral point. Line voltage = Phase voltage √ó 1.732. Provides both line-to-line and line-to-neutral voltages.",
    "analogy": "Three branches meeting at a central point, like a Y intersection.",
    "unit": "Three-Phase (Config)",
    "tags": "three_phase|configuration"
  },
  {
    "term": "Delta (Œî) Connection",
    "definition": "Three-phase configuration forming a closed triangle with no neutral. Line current = Phase current √ó 1.732. Common in motor windings.",
    "analogy": "Three branches forming a triangle, like the Greek letter delta.",
    "unit": "Three-Phase (Config)",
    "tags": "three_phase|configuration"
  },
  {
    "term": "Line Voltage",
    "definition": "Voltage measured between any two phases in a three-phase system. In aircraft Wye systems: 200V (line-to-line).",
    "analogy": "The voltage between two different 'hot' wires.",
    "unit": "Volt (V)",
    "tags": "three_phase|measurement"
  },
  {
    "term": "Phase Voltage",
    "definition": "Voltage measured between a phase and neutral in a Wye system. In aircraft: 115V (phase-to-neutral).",
    "analogy": "The voltage from one 'hot' wire to the neutral or ground.",
    "unit": "Volt (V)",
    "tags": "three_phase|measurement"
  },
  {
    "term": "Single-Phasing",
    "definition": "A fault condition where one phase of a three-phase system is lost, causing motors to overheat and draw excessive current on remaining phases.",
    "analogy": "Like a three-cylinder engine running on only two cylinders - rough and damaging.",
    "unit": "Fault (Three-Phase)",
    "tags": "three_phase|fault|troubleshooting"
  },
  {
    "term": "Synchronous Speed",
    "definition": "The speed of the rotating magnetic field in an AC motor, calculated as N_s = 120f/P (where f = frequency, P = poles). Determines maximum motor speed.",
    "analogy": "The speed limit set by the frequency and motor design.",
    "unit": "RPM",
    "tags": "motors|formula"
  },
  {
    "term": "Slip",
    "definition": "The difference between synchronous speed and actual rotor speed in an induction motor, expressed as a percentage. Motors need slip to produce torque.",
    "analogy": "How much the rotor 'falls behind' the rotating magnetic field.",
    "unit": "Percentage (%)",
    "tags": "motors|concept"
  },
  {
    "term": "True RMS Meter",
    "definition": "A multimeter that accurately measures the RMS value of any AC waveform, not just pure sine waves. Essential for accurate AC measurements in aircraft systems.",
    "analogy": "A 'smart' meter that correctly calculates effective values for any wave shape.",
    "unit": "Tool",
    "tags": "measurement|tool"
  },
  {
    "term": "Capacitor Safety",
    "definition": "Capacitors retain charge after power is removed and can deliver dangerous shocks. Must be properly discharged before servicing any circuit containing capacitors.",
    "analogy": "A loaded spring that can release its energy suddenly even after the system is 'off'.",
    "unit": "Safety",
    "tags": "safety|capacitance|maintenance"
  },
  {
    "term": "Current Transformer (CT)",
    "definition": "A transformer used to safely measure high AC currents by producing a proportional low current in the secondary. Never leave CT secondary open while energized.",
    "analogy": "A safe way to 'sample' high currents without putting the meter directly in the circuit.",
    "unit": "Device",
    "tags": "transformers|measurement|safety"
  }
  ];

  function uidFrom(str){
    let h=0; for(let i=0;i<str.length;i++){ h=(h<<5)-h+str.charCodeAt(i); h|=0 }
    return Math.abs(h).toString(36);
  }
  function normalizeTags(t){
    if(Array.isArray(t)) return t.map(s=>String(s).trim()).filter(Boolean);
    if(typeof t === 'string') return t.split(/[|,]/).map(s=>s.trim()).filter(Boolean);
    return [];
  }
  const DATA = FIXED_CARDS.map(c=>({ ...c, id: uidFrom(c.term+'::'+c.definition), tags: normalizeTags(c.tags) }));

  // ---------- Storage ----------
  const LS_KEY = 'glossary.mastery';
  function loadMap(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||{} }catch{ return {} } }
  function saveMap(m){ try{ localStorage.setItem(LS_KEY, JSON.stringify(m)) }catch{} }

  // ---------- SM-2 ----------
  const DAY = 24*60*60*1000;
  function scheduleNext(state, rating){
    const q = rating==='difficult'?2: rating==='medium'?4:5;
    let { reps=0, ivl=0, ease=2.5 } = state||{};
    const now = Date.now();
    if(q < 3){ reps=0; ivl=1; }
    else { if(reps===0) ivl=1; else if(reps===1) ivl=6; else ivl=Math.max(1, Math.round(ivl*ease)); reps+=1; }
    ease = Math.max(1.3, ease + 0.1 - (5-q)*(0.08 + (5-q)*0.02));
    const due = now + ivl*DAY;
    return { ...state, rating, reps, ivl, ease, due, last: now };
  }

  // ---------- State ----------
  const state = {
    mastery: loadMap(),
    deck: 'all',
    query: '',
    tags: new Set(),
    idx: 0,
    flipped: false
  };

  // ---------- Elements ----------
  const $front = document.getElementById('front');
  const $back = document.getElementById('back');
  const $flip = document.getElementById('flip');
  const $list = document.getElementById('list');
  const $tags = document.getElementById('tags');
  const $search = document.getElementById('search');
  const $prev = document.getElementById('prev');
  const $next = document.getElementById('next');
  const $rateEasy = document.getElementById('rateEasy');
  const $rateMedium = document.getElementById('rateMedium');
  const $rateDifficult = document.getElementById('rateDifficult');
  const $chips = Array.from(document.querySelectorAll('.deck-switch .chip'));
  const $counts = {
    easy: document.querySelector('[data-count="easy"]'),
    medium: document.querySelector('[data-count="medium"]'),
    difficult: document.querySelector('[data-count="difficult"]')
  };

  // ---------- Derived ----------
  function filtered(){
    const q = state.query.trim().toLowerCase();
    const base = DATA;
    const byQ = q ? base.filter(d => (d.term||'').toLowerCase().includes(q) || (d.definition||'').toLowerCase().includes(q) || (d.unit||'').toLowerCase().includes(q) || (d.tags||[]).some(t=>t.toLowerCase().includes(q))) : base;
    const byTags = state.tags.size ? byQ.filter(d => (d.tags||[]).some(t=>state.tags.has(t))) : byQ;
    const byDeck = state.deck==='all' ? byTags : byTags.filter(d => (state.mastery[d.id]?.rating||'medium') === state.deck);
    return byDeck;
  }

  function computeTagIndex(){
    const counts = {};
    DATA.forEach(it => (it.tags||[]).forEach(t => { if(!t) return; counts[t]=(counts[t]||0)+1; }));
    return Object.entries(counts).sort((a,b)=> b[1]-a[1] || String(a[0]).localeCompare(String(b[0])));
  }

  function computeCounts(){
    const easy = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='easy').length;
    const med  = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='medium').length;
    const dif  = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='difficult').length;
    $counts.easy.textContent = `(${easy})`;
    $counts.medium.textContent = `(${med})`;
    $counts.difficult.textContent = `(${dif})`;
  }

  // ---------- Render ----------
  function renderCard(){
    const items = filtered();
    if(items.length===0){
      $front.innerHTML = `<div class="empty">No terms match your search or selected tags.</div>`;
      $back.innerHTML = '';
      return;
    }
    if(state.idx >= items.length) state.idx = 0;
    const cur = items[state.idx];
    const rating = (state.mastery[cur.id]?.rating)||'medium';
    $front.innerHTML = `
      <div>
        <div class="meta">Term</div>
        <div class="term">${escapeHTML(cur.term)}</div>
        <div class="unit">${escapeHTML(cur.unit||'')}</div>
        <div style="margin-top:8px">${(cur.tags||[]).map(t=>`<span class="badge">${escapeHTML(t)}</span>`).join('')}</div>
      </div>`;
    $back.innerHTML = `
      <div>
        <div class="meta">Definition</div>
        <div class="def">${escapeHTML(cur.definition)}</div>
      </div>`;

    setActive($rateEasy, rating==='easy');
    setActive($rateMedium, rating==='medium');
    setActive($rateDifficult, rating==='difficult');
  }

  function renderList(){
    const items = filtered();
    if(items.length===0){ $list.innerHTML = `<div class="empty">No terms match your search or selected tags.</div>`; return; }
    $list.innerHTML = items.map(it=>{
      const r = (state.mastery[it.id]?.rating)||'medium';
      const color = r==='easy' ? 'background:var(--green);color:#fff' : r==='medium' ? 'background:var(--yellow);color:#fff' : 'background:var(--red);color:#fff';
      return `<div class="list-item">
        <div class="title">${escapeHTML(it.term)}</div>
        <div class="line">${escapeHTML(it.definition)}</div>
        <div class="line">${escapeHTML(it.unit||'')}${(it.tags||[]).length?' ‚Ä¢ ':''}${(it.tags||[]).map(escapeHTML).join(', ')}</div>
        <div class="line"><span class="badge" style="${color}">${r[0].toUpperCase()+r.slice(1)}</span></div>
      </div>`
    }).join('');
  }

  function renderTags(){
    const idx = computeTagIndex();
    $tags.innerHTML = idx.slice(0,24).map(([tag,count])=>{
      const active = state.tags.has(tag);
      return `<button class="tag ${active?'active':''}" data-tag="${encodeURIComponent(tag)}">${escapeHTML(tag)} <span style="opacity:.7">(${count})</span></button>`;
    }).join('') + (state.tags.size? ' <button class="tag" id="clearTags">Clear</button>': '');
  }

  function renderAll(){
    computeCounts();
    renderCard();
    renderList();
    renderTags();
  }

  // ---------- Utils ----------
  function setActive(btn, on){
    const classes = btn.className.split(' ').filter(Boolean);
    const has = classes.includes('active');
    if(on && !has) btn.className += ' active';
    if(!on && has) btn.className = classes.filter(c=>c!=='active').join(' ');
  }
  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
  }

  // ---------- Events ----------
  $flip.addEventListener('click', ()=>{ state.flipped=!state.flipped; $flip.classList.toggle('is-flipped', state.flipped); });
  $prev.addEventListener('click', ()=>{ const len=filtered().length||1; state.flipped=false; state.idx=(state.idx-1+len)%len; renderCard(); });
  $next.addEventListener('click', ()=>{ const len=filtered().length||1; state.flipped=false; state.idx=(state.idx+1)%len; renderCard(); });

  $rateEasy.addEventListener('click', ()=>rate('easy'));
  $rateMedium.addEventListener('click', ()=>rate('medium'));
  $rateDifficult.addEventListener('click', ()=>rate('difficult'));

  $chips.forEach(ch=> ch.addEventListener('click', ()=>{
    $chips.forEach(b=>b.classList.remove('active'));
    ch.classList.add('active');
    state.deck = ch.dataset.deck;
    state.idx = 0; state.flipped=false; $flip.classList.remove('is-flipped');
    renderAll();
  }));

  $tags.addEventListener('click', (e)=>{
    const t = e.target.closest('[data-tag]');
    if(t){
      const tag = decodeURIComponent(t.getAttribute('data-tag'));
      if(state.tags.has(tag)) state.tags.delete(tag); else state.tags.add(tag);
      state.idx=0; state.flipped=false; $flip.classList.remove('is-flipped');
      renderAll();
    }
    if(e.target && e.target.id==='clearTags'){ state.tags.clear(); renderAll(); }
  });

  $search.addEventListener('input', ()=>{ state.query = $search.value; state.idx=0; renderAll(); });

  window.addEventListener('keydown', (e)=>{
    const tag = (e.target && e.target.tagName||'').toLowerCase();
    if(tag==='input' || tag==='textarea') return;
    if(e.code==='ArrowLeft'){ e.preventDefault(); $prev.click(); }
    if(e.code==='ArrowRight'){ e.preventDefault(); $next.click(); }
    if(e.code==='Space'){ e.preventDefault(); $flip.click(); }
  });

  function rate(level){
    const items = filtered(); if(items.length===0) return;
    const cur = items[state.idx];
    const st = state.mastery[cur.id] || { rating:'medium', seen:0, correct:0, last:0, reps:0, ivl:0, ease:2.5, due:0 };
    const next = scheduleNext(st, level);
    state.mastery[cur.id] = next; saveMap(state.mastery);
    computeCounts();
    $next.click();
  }

  // ---------- Init ----------
  DATA.forEach(it=>{ if(!state.mastery[it.id]) state.mastery[it.id] = { rating:'medium', seen:0, correct:0, last:0, reps:0, ivl:0, ease:2.5, due:0 }; });
  saveMap(state.mastery);
  renderAll();

  // ---------- Finish Session & Report to Parent ----------
  function finishSession() {
    // Calculate score based on mastery ratings
    const total = DATA.length;
    const easy = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='easy').length;
    const medium = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='medium').length;
    const difficult = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='difficult').length;

    // Score: easy cards = 100%, medium = 50%, difficult = 0%
    const score = Math.round((easy + medium * 0.5) / total * 100);

    // Try to send to parent page
    try {
      if (window.parent && window.parent.completeModule) {
        console.log('‚úÖ Sending flashcards score to parent page:', score + '%');
        window.parent.completeModule('flashcards', score);

        alert(`üìö Study Session Complete!\n\nYour Progress:\n‚úÖ Easy: ${easy} cards\n‚ö†Ô∏è Medium: ${medium} cards\n‚ùå Difficult: ${difficult} cards\n\nüìä Score: ${score}%\n\nKeep studying to improve!`);

        // Return to home view after 1 second
        setTimeout(() => {
          if (window.parent && window.parent.showTab) {
            window.parent.showTab('home');
          }
        }, 1000);
      } else {
        console.log('‚ö†Ô∏è Parent page not available - running standalone');
        alert(`üìö Study Session Complete!\n\nYour Progress:\n‚úÖ Easy: ${easy} cards\n‚ö†Ô∏è Medium: ${medium} cards\n‚ùå Difficult: ${difficult} cards\n\nüìä Score: ${score}%\n\n(Gamification not available in standalone mode)`);
      }
    } catch (e) {
      console.error('Error communicating with parent page:', e);
      alert(`üìö Study Session Complete!\n\nScore: ${score}%\nEasy: ${easy}, Medium: ${medium}, Difficult: ${difficult}`);
    }
  }

  // Attach finish session button handler
  const $finishBtn = document.getElementById('finishSession');
  if ($finishBtn) {
    $finishBtn.addEventListener('click', finishSession);
  }

  // ---------- Lightweight tests (no special chars) ----------
  ;(function runTests(){
    try{
      if(!(Array.isArray(DATA) && DATA.length>0)) console.error('Test failed: dataset missing');
      const total = DATA.length;
      const counts = ['easy','medium','difficult'].map(k=> DATA.filter(d => (state.mastery[d.id]?.rating||'medium')===k).length).reduce((a,b)=>a+b,0);
      if(!(counts<=total)) console.error('Test failed: deck counts');
    }catch(e){ console.error('Self-test error', e); }
  })();
})();
</script>
</body>
</html>
