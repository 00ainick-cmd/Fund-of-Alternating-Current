<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> CAET Flash Cards ‚Äì Standalone </title>
  <style>
    :root{
      --bg: #f8fafc; /* slate-50 */
      --card: #ffffff;
      --text: #0f172a; /* slate-900 */
      --muted: #64748b; /* slate-500 */
      --border: #e2e8f0; /* slate-200 */
      --ring: #cbd5e1; /* slate-300 */
      --green: #16a34a; /* green-600 */
      --green-50: #ecfdf5;
      --yellow: #f59e0b; /* yellow-500 */
      --yellow-50: #fffbeb;
      --red: #dc2626; /* red-600 */
      --red-50: #fef2f2;
      --shadow: 0 10px 20px rgba(2, 6, 23, 0.06), 0 2px 6px rgba(2, 6, 23, 0.06);
    }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(to bottom,var(--bg),#fff);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:28px;letter-spacing:-0.01em;display:flex;align-items:center;gap:10px}
    .sparkle{width:24px;height:24px}
    .deck-switch{display:inline-flex;border:1px solid var(--border);border-radius:999px;padding:6px;background:#fff;box-shadow:var(--shadow)}
    .chip{border:1px solid transparent;background:transparent;color:var(--text);padding:6px 12px;border-radius:999px;cursor:pointer}
    .chip.active{background:#111827;color:#fff}

    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow)}
    .card h2{margin:0;padding:16px 20px;border-bottom:1px solid var(--border);font-size:18px}
    .card .content{padding:18px 20px}

    .flip{position:relative;height:300px;border-radius:16px;border:1px solid var(--border);background:#fff;cursor:pointer;user-select:none;perspective:1000px}
    .flip-inner{position:relative;height:100%;transform-style:preserve-3d;transition:transform .4s}
    .flip .face{position:absolute;inset:0;display:grid;place-items:center;backface-visibility:hidden;-webkit-backface-visibility:hidden;padding:16px;text-align:center}
    .flip .back{transform:rotateY(180deg)}
    .flip.is-flipped .flip-inner{transform:rotateY(180deg)}

    .meta{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.08em}
    .term{font-size:28px;font-weight:700;margin-top:6px}
    .unit{font-size:14px;color:var(--muted);margin-top:4px}
    .badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;margin:4px 4px 0 0}

    .def{max-width:70ch;font-size:18px;line-height:1.4;max-height:180px;overflow:auto;padding-right:8px}

    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:16px}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 14px;font-size:14px;cursor:pointer}
    .btn:focus{outline:2px solid var(--ring);outline-offset:2px}
    .btn-outline{background:#fff}
    .btn-primary{background:#111827;color:#fff;border-color:#111827}
    .btn-ghost{background:transparent}

    .btn-green{color:var(--green);border-color:#bbf7d0;background:var(--green-50)}
    .btn-green.active{background:var(--green);color:#fff;border-color:var(--green)}
    .btn-yellow{color:var(--yellow);border-color:#fef3c7;background:var(--yellow-50)}
    .btn-yellow.active{background:var(--yellow);color:#fff;border-color:var(--yellow)}
    .btn-red{color:var(--red);border-color:#fecaca;background:var(--red-50)}
    .btn-red.active{background:var(--red);color:#fff;border-color:var(--red)}

    .list{max-height:330px;overflow:auto;padding-right:6px}
    .list-item{border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:10px}
    .list-item .title{font-weight:600}
    .list-item .line{color:var(--muted);font-size:12px;margin-top:6px}

    .bottom{margin-top:20px}
    .tags{display:flex;flex-wrap:wrap;gap:8px}
    .tag{border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#fff;cursor:pointer}
    .tag.active{background:#111827;color:#fff;border-color:#111827}

    .search{display:flex;align-items:center;gap:10px;margin-top:12px}
    .search input{flex:1;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px}

    .empty{padding:28px;text-align:center;color:var(--muted)}

    @media (max-width:720px){
      header{flex-direction:column;align-items:flex-start;gap:12px}
      .row{flex-direction:column;align-items:stretch}
      .def{max-height:150px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>
        <svg class="sparkle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M12 2l1.9 4.6L18 8l-4.1 1.4L12 14l-1.9-4.6L6 8l4.1-1.4L12 2z"/>
        </svg>
        AEA Interactive Glossary
      </h1>
      <div class="deck-switch" id="deckSwitch">
        <button class="chip active" data-deck="all">All</button>
        <button class="chip" data-deck="easy">Easy <span class="count" data-count="easy"></span></button>
        <button class="chip" data-deck="medium">Medium <span class="count" data-count="medium"></span></button>
        <button class="chip" data-deck="difficult">Difficult <span class="count" data-count="difficult"></span></button>
      </div>
      <button class="btn btn-primary" id="finishSession" style="margin-top:8px;width:100%;max-width:200px;">Finish Session</button>
    </header>

    <section class="card">
      <h2>Study <span class="meta" style="margin-left:8px">[Space: Flip ‚Ä¢ ‚Üê/‚Üí: Prev/Next]</span></h2>
      <div class="content">
        <div class="flip" id="flip">
          <div class="flip-inner" id="flipInner">
            <div class="face front" id="front"></div>
            <div class="face back" id="back"></div>
          </div>
        </div>
        <div class="row">
          <div class="row" id="ratingRow">
            <button class="btn btn-green" id="rateEasy">Easy</button>
            <button class="btn btn-yellow" id="rateMedium">Medium</button>
            <button class="btn btn-red" id="rateDifficult">Difficult</button>
          </div>
          <div class="row">
            <button class="btn btn-outline" id="prev">Prev</button>
            <button class="btn btn-primary" id="next">Next ‚ñ∂</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h2>List View</h2>
      <div class="content">
        <div class="list" id="list"></div>
      </div>
    </section>

    <section class="card bottom" style="margin-bottom:8px">
      <h2>Filter</h2>
      <div class="content">
        <div class="tags" id="tags"></div>
        <div class="search">
          <input id="search" type="search" placeholder="Search term, definition, unit, or tag" />
        </div>
      </div>
    </section>
  </div>

<script>
(function(){
  // ---------- Data (embedded directly ‚Äì no document.write) ----------
const acFlashcardsData = [
  {
    "term": "Alternating Current (AC)",
    "definition": "Electric current that periodically reverses direction, rising from zero to a maximum positive value, returning to zero, and then falling to a maximum negative value.",
    "analogy": "A handsaw moving back and forth to cut wood, as opposed to a circular saw moving in one direction (DC).",
    "unit": "Ampere (A)",
    "tags": "AC 101|fundamentals|theory"
  },
  {
    "term": "Cycle",
    "definition": "One complete sequence of an AC waveform, consisting of one positive alternation and one negative alternation (360 degrees).",
    "analogy": "One full revolution of a generator armature or a bicycle wheel.",
    "unit": "N/A (Count)",
    "tags": "AC 101|fundamentals|waveform"
  },
  {
    "term": "Frequency (f)",
    "definition": "The number of complete cycles that occur in one second. In aircraft systems, the standard is often 400 Hz.",
    "analogy": "How fast a piston moves up and down in an engine (RPM), but measured in cycles per second.",
    "unit": "Hertz (Hz)",
    "tags": "AC 101|fundamentals|measurement"
  },
  {
    "term": "Period (T)",
    "definition": "The time it takes to complete one full cycle. It is the reciprocal of frequency (T = 1/f).",
    "analogy": "The time it takes for a pendulum to swing all the way out and back to the start.",
    "unit": "Second (s)",
    "tags": "AC 101|fundamentals|formula"
  },
  {
    "term": "RMS Voltage (Root Mean Square)",
    "definition": "The 'effective' voltage of an AC sine wave, equivalent to the DC voltage that would produce the same heating effect. Calculated as Peak Voltage √ó 0.707.",
    "analogy": "The 'average' strength of a boxer's punches throughout a round, rather than just their hardest single hit (Peak).",
    "unit": "Volts (VAC)",
    "tags": "AC 101|measurement|formula"
  },
  {
    "term": "Inductance (L)",
    "definition": "The property of a circuit component (inductor/coil) to oppose any change in current flow by generating a counter-EMF.",
    "analogy": "The flywheel effect; a heavy wheel is hard to start spinning and hard to stop, just as an inductor resists starting or stopping current.",
    "unit": "Henry (H)",
    "tags": "AC 102|components|theory"
  },
  {
    "term": "Inductive Reactance (XL)",
    "definition": "The opposition to AC current flow offered by an inductor, which increases as frequency increases (XL = 2œÄfL).",
    "analogy": "Walking through water; the faster you try to move (higher frequency), the more resistance the water pushes back with.",
    "unit": "Ohm (Œ©)",
    "tags": "AC 102|components|formula"
  },
  {
    "term": "Capacitance (C)",
    "definition": "The property of a circuit component (capacitor) to store energy in an electrostatic field and oppose any change in voltage.",
    "analogy": "A storage tank or balloon attached to a pipe; it absorbs pressure spikes (voltage changes) and releases pressure when the supply drops.",
    "unit": "Farad (F)",
    "tags": "AC 102|components|theory"
  },
  {
    "term": "Capacitive Reactance (XC)",
    "definition": "The opposition to AC current flow offered by a capacitor, which decreases as frequency increases (XC = 1 / 2œÄfC).",
    "analogy": "A flexible membrane blocking a pipe; rapid vibrations (high freq) pass through easily, but slow pushes (low freq) are blocked.",
    "unit": "Ohm (Œ©)",
    "tags": "AC 102|components|formula"
  },
  {
    "term": "ELI the ICE Man",
    "definition": "A mnemonic for phase relationships: In an Inductor (L), Voltage (E) leads Current (I). In a Capacitor (C), Current (I) leads Voltage (E).",
    "analogy": "A memory trick to remember who 'wins the race' (leads) in reactive circuits.",
    "unit": "N/A (Mnemonic)",
    "tags": "AC 102|theory|tool"
  },
  {
    "term": "Impedance (Z)",
    "definition": "The total opposition to current flow in an AC circuit, comprising Resistance (R), Inductive Reactance (XL), and Capacitive Reactance (XC).",
    "analogy": "The combined difficulty of running an obstacle course: the distance (Resistance) plus the hurdles (Reactance).",
    "unit": "Ohm (Œ©)",
    "tags": "AC 103|theory|formula"
  },
  {
    "term": "Resonance",
    "definition": "The condition in an AC circuit where Inductive Reactance equals Capacitive Reactance (XL = XC). At this point, they cancel each other out, leaving only pure resistance.",
    "analogy": "Pushing a child on a swing at exactly the right timing so practically no effort is needed to keep it moving.",
    "unit": "Hertz (Hz)",
    "tags": "AC 103|theory|phenomenon"
  },
  {
    "term": "Transformer",
    "definition": "A device that transfers electrical energy from one circuit to another through mutual inductance, usually changing voltage and current levels.",
    "analogy": "A gearbox in a car; it can trade speed (voltage) for torque (current), but the horsepower (power) remains roughly the same.",
    "unit": "N/A (Device)",
    "tags": "AC 104|components|theory"
  },
  {
    "term": "Step-Up Transformer",
    "definition": "A transformer where the secondary winding has more turns than the primary, increasing voltage but decreasing current.",
    "analogy": "A lever setup where a short movement (low voltage) creates a large movement (high voltage), but with less force (current).",
    "unit": "N/A (Configuration)",
    "tags": "AC 104|components|configuration"
  },
  {
    "term": "True Power (P)",
    "definition": "The power actually consumed and converted into heat or work by the resistive part of the circuit.",
    "analogy": "The beer you actually drink from the mug (excluding the foam).",
    "unit": "Watt (W)",
    "tags": "AC 105|power|measurement"
  },
  {
    "term": "Apparent Power (S)",
    "definition": "The product of the RMS voltage and RMS current (V √ó I) without regard to phase shift.",
    "analogy": "The total volume of the mug, including both the beer (True Power) and the foam (Reactive Power).",
    "unit": "Volt-Ampere (VA)",
    "tags": "AC 105|power|measurement"
  },
  {
    "term": "Reactive Power (Q)",
    "definition": "Power that oscillates back and forth between the source and the reactive components (inductors/capacitors) without doing useful work.",
    "analogy": "The foam on the beer; it takes up space in the glass (circuit capacity) but doesn't quench your thirst.",
    "unit": "Volt-Ampere Reactive (VAR)",
    "tags": "AC 105|power|measurement"
  },
  {
    "term": "Power Factor (PF)",
    "definition": "The ratio of True Power to Apparent Power (Watts / VA). It indicates how efficiently current is being converted into useful work.",
    "analogy": "A percentage score of how much 'beer' vs 'foam' is in your glass. 100% (1.0) is ideal.",
    "unit": "Decimal or %",
    "tags": "AC 105|power|efficiency"
  }
];

  function uidFrom(str){
    let h=0; for(let i=0;i<str.length;i++){ h=(h<<5)-h+str.charCodeAt(i); h|=0 }
    return Math.abs(h).toString(36);
  }
  function normalizeTags(t){
    if(Array.isArray(t)) return t.map(s=>String(s).trim()).filter(Boolean);
    if(typeof t === 'string') return t.split(/[|,]/).map(s=>s.trim()).filter(Boolean);
    return [];
  }
  const DATA = FIXED_CARDS.map(c=>({ ...c, id: uidFrom(c.term+'::'+c.definition), tags: normalizeTags(c.tags) }));

  // ---------- Storage ----------
  const LS_KEY = 'glossary.mastery';
  function loadMap(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||{} }catch{ return {} } }
  function saveMap(m){ try{ localStorage.setItem(LS_KEY, JSON.stringify(m)) }catch{} }

  // ---------- SM-2 ----------
  const DAY = 24*60*60*1000;
  function scheduleNext(state, rating){
    const q = rating==='difficult'?2: rating==='medium'?4:5;
    let { reps=0, ivl=0, ease=2.5 } = state||{};
    const now = Date.now();
    if(q < 3){ reps=0; ivl=1; }
    else { if(reps===0) ivl=1; else if(reps===1) ivl=6; else ivl=Math.max(1, Math.round(ivl*ease)); reps+=1; }
    ease = Math.max(1.3, ease + 0.1 - (5-q)*(0.08 + (5-q)*0.02));
    const due = now + ivl*DAY;
    return { ...state, rating, reps, ivl, ease, due, last: now };
  }

  // ---------- State ----------
  const state = {
    mastery: loadMap(),
    deck: 'all',
    query: '',
    tags: new Set(),
    idx: 0,
    flipped: false
  };

  // ---------- Elements ----------
  const $front = document.getElementById('front');
  const $back = document.getElementById('back');
  const $flip = document.getElementById('flip');
  const $list = document.getElementById('list');
  const $tags = document.getElementById('tags');
  const $search = document.getElementById('search');
  const $prev = document.getElementById('prev');
  const $next = document.getElementById('next');
  const $rateEasy = document.getElementById('rateEasy');
  const $rateMedium = document.getElementById('rateMedium');
  const $rateDifficult = document.getElementById('rateDifficult');
  const $chips = Array.from(document.querySelectorAll('.deck-switch .chip'));
  const $counts = {
    easy: document.querySelector('[data-count="easy"]'),
    medium: document.querySelector('[data-count="medium"]'),
    difficult: document.querySelector('[data-count="difficult"]')
  };

  // ---------- Derived ----------
  function filtered(){
    const q = state.query.trim().toLowerCase();
    const base = DATA;
    const byQ = q ? base.filter(d => (d.term||'').toLowerCase().includes(q) || (d.definition||'').toLowerCase().includes(q) || (d.unit||'').toLowerCase().includes(q) || (d.tags||[]).some(t=>t.toLowerCase().includes(q))) : base;
    const byTags = state.tags.size ? byQ.filter(d => (d.tags||[]).some(t=>state.tags.has(t))) : byQ;
    const byDeck = state.deck==='all' ? byTags : byTags.filter(d => (state.mastery[d.id]?.rating||'medium') === state.deck);
    return byDeck;
  }

  function computeTagIndex(){
    const counts = {};
    DATA.forEach(it => (it.tags||[]).forEach(t => { if(!t) return; counts[t]=(counts[t]||0)+1; }));
    return Object.entries(counts).sort((a,b)=> b[1]-a[1] || String(a[0]).localeCompare(String(b[0])));
  }

  function computeCounts(){
    const easy = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='easy').length;
    const med  = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='medium').length;
    const dif  = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='difficult').length;
    $counts.easy.textContent = `(${easy})`;
    $counts.medium.textContent = `(${med})`;
    $counts.difficult.textContent = `(${dif})`;
  }

  // ---------- Render ----------
  function renderCard(){
    const items = filtered();
    if(items.length===0){
      $front.innerHTML = `<div class="empty">No terms match your search or selected tags.</div>`;
      $back.innerHTML = '';
      return;
    }
    if(state.idx >= items.length) state.idx = 0;
    const cur = items[state.idx];
    const rating = (state.mastery[cur.id]?.rating)||'medium';
    $front.innerHTML = `
      <div>
        <div class="meta">Term</div>
        <div class="term">${escapeHTML(cur.term)}</div>
        <div class="unit">${escapeHTML(cur.unit||'')}</div>
        <div style="margin-top:8px">${(cur.tags||[]).map(t=>`<span class="badge">${escapeHTML(t)}</span>`).join('')}</div>
      </div>`;
    $back.innerHTML = `
      <div>
        <div class="meta">Definition</div>
        <div class="def">${escapeHTML(cur.definition)}</div>
      </div>`;

    setActive($rateEasy, rating==='easy');
    setActive($rateMedium, rating==='medium');
    setActive($rateDifficult, rating==='difficult');
  }

  function renderList(){
    const items = filtered();
    if(items.length===0){ $list.innerHTML = `<div class="empty">No terms match your search or selected tags.</div>`; return; }
    $list.innerHTML = items.map(it=>{
      const r = (state.mastery[it.id]?.rating)||'medium';
      const color = r==='easy' ? 'background:var(--green);color:#fff' : r==='medium' ? 'background:var(--yellow);color:#fff' : 'background:var(--red);color:#fff';
      return `<div class="list-item">
        <div class="title">${escapeHTML(it.term)}</div>
        <div class="line">${escapeHTML(it.definition)}</div>
        <div class="line">${escapeHTML(it.unit||'')}${(it.tags||[]).length?' ‚Ä¢ ':''}${(it.tags||[]).map(escapeHTML).join(', ')}</div>
        <div class="line"><span class="badge" style="${color}">${r[0].toUpperCase()+r.slice(1)}</span></div>
      </div>`
    }).join('');
  }

  function renderTags(){
    const idx = computeTagIndex();
    $tags.innerHTML = idx.slice(0,24).map(([tag,count])=>{
      const active = state.tags.has(tag);
      return `<button class="tag ${active?'active':''}" data-tag="${encodeURIComponent(tag)}">${escapeHTML(tag)} <span style="opacity:.7">(${count})</span></button>`;
    }).join('') + (state.tags.size? ' <button class="tag" id="clearTags">Clear</button>': '');
  }

  function renderAll(){
    computeCounts();
    renderCard();
    renderList();
    renderTags();
  }

  // ---------- Utils ----------
  function setActive(btn, on){
    const classes = btn.className.split(' ').filter(Boolean);
    const has = classes.includes('active');
    if(on && !has) btn.className += ' active';
    if(!on && has) btn.className = classes.filter(c=>c!=='active').join(' ');
  }
  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
  }

  // ---------- Events ----------
  $flip.addEventListener('click', ()=>{ state.flipped=!state.flipped; $flip.classList.toggle('is-flipped', state.flipped); });
  $prev.addEventListener('click', ()=>{ const len=filtered().length||1; state.flipped=false; state.idx=(state.idx-1+len)%len; renderCard(); });
  $next.addEventListener('click', ()=>{ const len=filtered().length||1; state.flipped=false; state.idx=(state.idx+1)%len; renderCard(); });

  $rateEasy.addEventListener('click', ()=>rate('easy'));
  $rateMedium.addEventListener('click', ()=>rate('medium'));
  $rateDifficult.addEventListener('click', ()=>rate('difficult'));

  $chips.forEach(ch=> ch.addEventListener('click', ()=>{
    $chips.forEach(b=>b.classList.remove('active'));
    ch.classList.add('active');
    state.deck = ch.dataset.deck;
    state.idx = 0; state.flipped=false; $flip.classList.remove('is-flipped');
    renderAll();
  }));

  $tags.addEventListener('click', (e)=>{
    const t = e.target.closest('[data-tag]');
    if(t){
      const tag = decodeURIComponent(t.getAttribute('data-tag'));
      if(state.tags.has(tag)) state.tags.delete(tag); else state.tags.add(tag);
      state.idx=0; state.flipped=false; $flip.classList.remove('is-flipped');
      renderAll();
    }
    if(e.target && e.target.id==='clearTags'){ state.tags.clear(); renderAll(); }
  });

  $search.addEventListener('input', ()=>{ state.query = $search.value; state.idx=0; renderAll(); });

  window.addEventListener('keydown', (e)=>{
    const tag = (e.target && e.target.tagName||'').toLowerCase();
    if(tag==='input' || tag==='textarea') return;
    if(e.code==='ArrowLeft'){ e.preventDefault(); $prev.click(); }
    if(e.code==='ArrowRight'){ e.preventDefault(); $next.click(); }
    if(e.code==='Space'){ e.preventDefault(); $flip.click(); }
  });

  function rate(level){
    const items = filtered(); if(items.length===0) return;
    const cur = items[state.idx];
    const st = state.mastery[cur.id] || { rating:'medium', seen:0, correct:0, last:0, reps:0, ivl:0, ease:2.5, due:0 };
    const next = scheduleNext(st, level);
    state.mastery[cur.id] = next; saveMap(state.mastery);
    computeCounts();
    $next.click();
  }

  // ---------- Init ----------
  DATA.forEach(it=>{ if(!state.mastery[it.id]) state.mastery[it.id] = { rating:'medium', seen:0, correct:0, last:0, reps:0, ivl:0, ease:2.5, due:0 }; });
  saveMap(state.mastery);
  renderAll();

  // ---------- Finish Session & Report to Parent ----------
  function finishSession() {
    // Calculate score based on mastery ratings
    const total = DATA.length;
    const easy = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='easy').length;
    const medium = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='medium').length;
    const difficult = DATA.filter(d => (state.mastery[d.id]?.rating||'medium')==='difficult').length;

    // Score: easy cards = 100%, medium = 50%, difficult = 0%
    const score = Math.round((easy + medium * 0.5) / total * 100);

    // Try to send to parent page
    try {
      if (window.parent && window.parent.completeModule) {
        console.log('‚úÖ Sending flashcards score to parent page:', score + '%');
        window.parent.completeModule('flashcards', score);

        alert(`üìö Study Session Complete!\n\nYour Progress:\n‚úÖ Easy: ${easy} cards\n‚ö†Ô∏è Medium: ${medium} cards\n‚ùå Difficult: ${difficult} cards\n\nüìä Score: ${score}%\n\nKeep studying to improve!`);

        // Return to home view after 1 second
        setTimeout(() => {
          if (window.parent && window.parent.showTab) {
            window.parent.showTab('home');
          }
        }, 1000);
      } else {
        console.log('‚ö†Ô∏è Parent page not available - running standalone');
        alert(`üìö Study Session Complete!\n\nYour Progress:\n‚úÖ Easy: ${easy} cards\n‚ö†Ô∏è Medium: ${medium} cards\n‚ùå Difficult: ${difficult} cards\n\nüìä Score: ${score}%\n\n(Gamification not available in standalone mode)`);
      }
    } catch (e) {
      console.error('Error communicating with parent page:', e);
      alert(`üìö Study Session Complete!\n\nScore: ${score}%\nEasy: ${easy}, Medium: ${medium}, Difficult: ${difficult}`);
    }
  }

  // Attach finish session button handler
  const $finishBtn = document.getElementById('finishSession');
  if ($finishBtn) {
    $finishBtn.addEventListener('click', finishSession);
  }

  // ---------- Lightweight tests (no special chars) ----------
  ;(function runTests(){
    try{
      if(!(Array.isArray(DATA) && DATA.length>0)) console.error('Test failed: dataset missing');
      const total = DATA.length;
      const counts = ['easy','medium','difficult'].map(k=> DATA.filter(d => (state.mastery[d.id]?.rating||'medium')===k).length).reduce((a,b)=>a+b,0);
      if(!(counts<=total)) console.error('Test failed: deck counts');
    }catch(e){ console.error('Self-test error', e); }
  })();
})();
</script>
</body>
</html>
